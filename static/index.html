<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Random Photo Display</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden; /* Hide scrollbars */
      }
      .image-container {
        display: flex;
        position: relative; /* Overlap overlays on the image */
        width: 100vw;
        height: 100vh;
      }

      .image-container img {
        object-fit: contain; /* Prevent image cropping */
        width: 100%; /* Stretch image to container width */
        background-color: black;
      }

      .overlay-wrapper {
        display: flex; /* Use flexbox for overlays */
        flex-direction: column-reverse; /* Location on top, date below */
        align-items: flex-end; /* Align overlays to right */
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }

      .date-overlay,
      .location-overlay {
        padding: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white; /* Text color for visibility on black background */
        font-size: 30px; /* Increased font size */
        font-family: "Open Sans", sans-serif; /* Nicer font family */
      }

      .date-overlay {
        margin-bottom: 10px; /* Spacing between overlays */
      }
    </style>
  </head>
  <body>
    <div class="image-container">
      <img id="random-photo" src="" alt="Random Photo" />
      <div class="overlay-wrapper">
        <div class="date-overlay"></div>
        <div class="location-overlay"></div>
      </div>
    </div>
    <script>
      const imgElement = document.getElementById("random-photo");
      const randomEndpoint = "/api/asset/random";
      const imageEndpoint = "/api/asset/file/";
      const metadataEndpoint = "/api/asset/:id"; // Use template literal for dynamic ID

      async function getRandomImage() {
        let imageUrl;
        while (true) {
          try {
            const response = await fetch(randomEndpoint);
            const data = await response.json();
            const assetId = data[0].id;
            const metadataUrl = metadataEndpoint.replace(":id", assetId); // Replace ID

            const metadataResponse = await fetch(metadataUrl);
            const metadata = await metadataResponse.json();

            if (metadata.type === "IMAGE") {
              imageUrl = imageEndpoint + assetId;
              displayImageWithOverlay(imageUrl, metadata);
              //imageUrl = imageEndpoint + assetId + "?isWeb=true";
              break; // Exit loop if it's an image
            }
          } catch (error) {
            console.error("Error fetching random asset:", error);
          }
        }

        if (imageUrl) {
          // Pre-fetch the next image (assuming another endpoint exists)
          fetch(imageUrl).catch((error) =>
            console.error("Error pre-fetching next image:", error),
          );

          // Update image if already loaded
          if (imgElement.complete) {
            imgElement.src = imageUrl;
          }
        } else {
          console.warn("No image found in recent attempts.");
        }
      }

      function getFormattedDate(dateTimeString) {
        const date = new Date(dateTimeString);
        const month = date.toLocaleString("default", { month: "long" });
        const day = date.getDate();
        const year = date.getFullYear();
        return `${month} ${day}, ${year}`;
      }
      function getFormattedLocation(metadata) {
        const locationParts = [];
        if (metadata.exifInfo.city) {
          locationParts.push(metadata.exifInfo.city);
        }
        if (metadata.exifInfo.state) {
          locationParts.push(metadata.exifInfo.state);
        }
        if (metadata.exifInfo.country) {
          locationParts.push(metadata.exifInfo.country);
        }

        // Check if any location parts were added
        if (locationParts.length === 0) {
          return null; // Return null if no location information is available
        } else {
          return locationParts.join(", "); // Join location parts with commas
        }
      }

      function displayImageWithOverlay(imageUrl, metadata) {
        const imgElement = document.getElementById("random-photo");
        const imageWrapper = imgElement.parentElement;

        // Clear any existing overlay elements (optional)
        const existingOverlays =
          imageWrapper.querySelectorAll(".image-overlay");
        existingOverlays.forEach((overlay) => overlay.remove());

        // Set image source
        imgElement.src = imageUrl;

        // Get formatted location (if available)
        const locationString = getFormattedLocation(metadata); // Call getFormattedLocation

        // Get formatted date
        const dateString = getFormattedDate(metadata.exifInfo.dateTimeOriginal);

        // Update location overlay (if location available)
        const locationOverlay = imageWrapper.querySelector(".location-overlay");
        if (locationString) {
          locationOverlay.textContent = locationString;
          locationOverlay.style.display = "block"; // Show location overlay
        } else {
          locationOverlay.style.display = "none"; // Hide location overlay if no location
        }

        // Update date overlay
        const dateOverlay = imageWrapper.querySelector(".date-overlay");
        dateOverlay.textContent = dateString;
        dateOverlay.style.display = "block"; // Show date overlay
      }

      getRandomImage(); // Get initial image
      setInterval(getRandomImage, 30000); // Repeat every 30 seconds
    </script>
  </body>
</html>
